!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@angular/core"),require("@angular/common"),require("rxjs/Rx")):"function"==typeof define&&define.amd?define(["exports","@angular/core","@angular/common","rxjs/Rx"],t):t(e.UiScroll={},e.ng.core,e.ng.common,e.Rx)}(this,function(e,t,n,o){"use strict";var i=null,r=null,l=function(e){i=setTimeout(function(){i=null,r&&(r(),r=null,l(e))},e)},u=function(){function e(){}return e.initialize=function(t){e.viewport=t.nativeElement,e.paddingTop=e.viewport.querySelector("[data-padding-top]"),e.paddingBottom=e.viewport.querySelector("[data-padding-bottom]")},e.viewport=null,e.paddingTop=null,e.paddingBottom=null,e}(),s=function(){function e(){}return e.setSource=function(e){if(!e||"object"!=typeof e||"function"!=typeof e.get)throw new Error("Invalid datasource!");c.source=e},e.setScrollerId=function(){c.scrollerId="0"},e.getItemId=function(e){return"i-"+c.scrollerId+"-"+e.toString()},e.getFirstVisibleItemIndex=function(){for(var e=0;e<c.items.length;e++)if(!c.items[e].invisible)return e;return-1},e.getFirstVisibleItem=function(){var e=c.getFirstVisibleItemIndex();if(e>=0)return c.items[e]},e.getLastVisibleItemIndex=function(){for(var e=c.items.length-1;e>=0;e--)if(!c.items[e].invisible)return e;return-1},e.getLastVisibleItem=function(){var e=c.getLastVisibleItemIndex();if(e>=0)return c.items[e]},e.initialize=function(e){c.setSource(e.datasource),c.setScrollerId(),e.getItems=function(){return c.items},e.getItemId=c.getItemId.bind(e)},e.startIndex=90,e.bufferSize=5,e.padding=.5,e.items=[],e.bof=!1,e.eof=!1,e.position=0,e.lastIndex=null,e}(),c=s,a=function(){function e(){}return e.opposite=function(e){return e===p.top?p.bottom:e===p.bottom?p.top:null},e.byScrollTop=function(){return s.position<u.viewport.scrollTop?p.bottom:s.position>u.viewport.scrollTop?p.top:null},e.isValid=function(e){return e===p.top||e===p.bottom},e.top="top",e.bottom="bottom",e}(),p=a,m=function(){function e(){}return e.run=function(e){return e===a.top?d.runTop():e===a.bottom?d.runBottom():void 0},e.shouldLoadBottom=function(){if(d.pendingBottom)return!1;var e=s.getLastVisibleItem();if(!e)return!0;var t=u.viewport.getBoundingClientRect().bottom;return e.element.getBoundingClientRect().bottom<=t},e.shouldLoadTop=function(){if(d.pendingTop)return!1;var e=s.getFirstVisibleItem();if(!e)return!0;var t=u.viewport.getBoundingClientRect().top;return e.element.getBoundingClientRect().top>=t},e.runTop=function(){return new Promise(function(e,t){if(d.shouldLoadTop()){d.pendingTop=!0;var n=(s.items.length?s.items[0].$index:null!==s.lastIndex?s.lastIndex:s.startIndex)-s.bufferSize;s.source.get(n,s.bufferSize).subscribe(function(t){d.pendingTop=!1,s.bof=t.length!==s.bufferSize;var o=t.map(function(e,t){return{$index:n+t,scope:e,invisible:!0}});s.items=o.concat(s.items),e(o)})}else t()})},e.runBottom=function(){return new Promise(function(e,t){if(d.shouldLoadBottom()){d.pendingBottom=!0;var n=s.items.length?s.items[s.items.length-1].$index+1:null!==s.lastIndex?s.lastIndex+1:s.startIndex;s.source.get(n,s.bufferSize).subscribe(function(t){d.pendingBottom=!1,s.eof=t.length!==s.bufferSize;var o=t.map(function(e,t){return{$index:n+t,scope:e,invisible:!0}});s.items=s.items.concat(o),e(o)})}else t()})},e.pendingTop=!1,e.pendingBottom=!1,e}(),d=m,f=function(){function e(){}return e.run=function(e,t){return void 0===e&&(e=null),void 0===t&&(t=null),new Promise(function(t,n){g.renderPending=!0,setTimeout(function(){g.renderPending=!1,e&&(g.setElements(e),t(e)),n()})})},e.setElements=function(e){e.forEach(function(e){for(var t=u.viewport.childNodes.length-1;t>=0;t--){var n=u.viewport.childNodes[t];n.id&&n.id===s.getItemId(e.$index)&&(e.element=n)}if(!e.element)throw new Error("Can not associate item with element")})},e.renderPending=!1,e}(),g=f,h=function(){function e(){}return e.run=function(e){return e===a.top?v.runTop():e===a.bottom?v.runBottom():void 0},e.runTop=function(){var e,t=u.viewport.getBoundingClientRect(),n=t.top-t.height*s.padding,o=s.items.length-1,i=0,r=-1,l=s.getFirstVisibleItemIndex(),c=s.items[o].element.getBoundingClientRect().bottom;if(c<n)e=Math.abs(s.items[l].element.getBoundingClientRect().top-c),r=o;else{for(i=l;i<=o;i++){if(s.items[i].element.getBoundingClientRect().bottom>n){r=i-1;break}}r>=l&&(e=s.items[r].element.getBoundingClientRect().bottom-s.items[l].element.getBoundingClientRect().top)}if(r>=l){for(i=l;i<=r;i++)s.items[i].element.style.display="none";var a=parseInt(u.paddingTop.style.height,10)||0;return u.paddingTop.style.height=a+e+"px",s.lastIndex=r===o?s.items[o].$index:null,s.items.splice(0,r+1),!0}return!1},e.runBottom=function(){var e,t,n=u.viewport.getBoundingClientRect(),o=n.bottom+n.height*s.padding,i=s.items.length-1,r=-1,l=s.getLastVisibleItemIndex(),c=s.items[0].element.getBoundingClientRect().top;if(c>o)t=Math.abs(s.items[l].element.getBoundingClientRect().bottom-c),r=0;else{for(e=0;e<=l;e++){if(s.items[e].element.getBoundingClientRect().top>o){r=e;break}}r>=0&&(t=s.items[l].element.getBoundingClientRect().bottom-s.items[r].element.getBoundingClientRect().top)}if(r>=0){for(e=r;e<=l;e++)s.items[e].element.style.display="none";var a=parseInt(u.paddingBottom.style.height,10)||0;return u.paddingBottom.style.height=a+t+"px",s.lastIndex=0===r?s.items[0].$index:null,s.items.splice(r,i+1-r),!0}return!1},e}(),v=h,b=function(){function e(){}return e.run=function(e,t){e===a.top&&I.runTop(t),e===a.bottom&&I.runBottom(t)},e.processInvisibleItems=function(e){for(var t=e.length-1;t>=0;t--){var n=e[t].element.children[0];n.style.left="",n.style.position="",delete e[t].invisible}return Math.abs(e[0].element.getBoundingClientRect().top-e[e.length-1].element.getBoundingClientRect().bottom)},e.runBottom=function(e){var t=I.processInvisibleItems(e),n=parseInt(u.paddingBottom.style.height,10)||0,o=Math.max(n-t,0);u.paddingBottom.style.height=o+"px"},e.runTop=function(e){var t=u.viewport.scrollTop,n=I.processInvisibleItems(e),o=parseInt(u.paddingTop.style.height,10)||0,i=Math.max(o-n,0);u.paddingTop.style.height=i+"px";var r=n-(o-i);if(r>0){n=r,u.viewport.scrollTop+=n;var l=n-u.viewport.scrollTop-t;if(l>0){var s=parseInt(u.paddingBottom.style.height,10)||0;u.paddingBottom.style.height=s+l+"px",u.viewport.scrollTop+=l}}},e}(),I=b,y={runChangeDetector:function(e){return null},initialize:function(e){y.runChangeDetector=function(t){return e.changeDetector.markForCheck(),t}},cycle:function(e){return o.Observable.create(function(t){m.run(e).then(function(e){return y.runChangeDetector(e)}).then(function(t){return f.run(t,e)}).then(function(n){b.run(e,n),s.position=u.viewport.scrollTop,h.run(a.opposite(e))&&y.runChangeDetector(null),s.position=u.viewport.scrollTop,console.log(e+" cycle is done"),t.next(e),t.complete()}).catch(function(n){console.log("Done "+e),n&&console.error(n),t.complete()})})},run:function(e){var t;if("string"==typeof e?t=e:(console.log("FIRE!"),t=a.byScrollTop()),a.isValid(t)){var n=function(){return y.cycle(t).subscribe(n)};n()}}},x=function(){function e(e,t,n){this.changeDetector=e,this.elementRef=t,this.renderer=n}return e.prototype.ngOnInit=function(){u.initialize(this.elementRef),s.initialize(this),y.initialize(this),this.onScrollListener=this.renderer.listen(u.viewport,"scroll",function(e){return t=function(){return y.run(e)},n=25,i?(r=t,clearTimeout(i)):t(),void l(n);var t,n}),y.run(a.bottom),y.run(a.top)},e.prototype.ngOnDestroy=function(){this.onScrollListener()},e.decorators=[{type:t.Component,args:[{selector:"ui-scroll",changeDetection:t.ChangeDetectionStrategy.OnPush,templateUrl:"./ui-scroll.component.html",styleUrls:["./ui-scroll.component.css"]}]}],e.ctorParameters=function(){return[{type:t.ChangeDetectorRef},{type:t.ElementRef},{type:t.Renderer2}]},e}(),B=function(){function e(e,t,n){this.templateRef=e,this.viewContainer=t,this.resolver=n}return Object.defineProperty(e.prototype,"uiScrollOf",{set:function(e){this.datasource=e},enumerable:!0,configurable:!0}),e.prototype.ngOnInit=function(){var e=this.templateRef.createEmbeddedView({}),t=this.resolver.resolveComponentFactory(x),n=this.viewContainer.createComponent(t,null,this.viewContainer.injector,[e.rootNodes]);n.instance.datasource=this.datasource,n.instance.template=this.templateRef},e.decorators=[{type:t.Directive,args:[{selector:"[uiScroll][uiScrollOf]"}]}],e.ctorParameters=function(){return[{type:t.TemplateRef},{type:t.ViewContainerRef},{type:t.ComponentFactoryResolver}]},e.propDecorators={uiScrollOf:[{type:t.Input}]},e}(),C=function(){function e(){}return e.decorators=[{type:t.NgModule,args:[{declarations:[x,B],imports:[n.CommonModule],entryComponents:[x],exports:[B]}]}],e.ctorParameters=function(){return[]},e}();e.UiScrollModule=C,Object.defineProperty(e,"__esModule",{value:!0})});